- name: Copy {{ COMPONENT }} repo
  ansible.builtin.copy:
    src: "{{ COMPONENT }}.repo"
    dest: /etc/yum.repos.d/{{ COMPONENT }}.repo

- name: Install {{ COMPONENT }}
  ansible.builtin.package:
    name: mysql-community-server
    state: present

- name: Start {{ COMPONENT }}
  systemd:
    name: mysqld
    state: restarted
    enabled: yes

- name: Fetch log from remote nodejs
  ansible.builtin.slurp:
    src: /var/log/mysqld.log
  register: pwd_log

- name: Extract root password
  ansible.builtin.set_fact:
    DEFAULT_PASSWORD: "{{ pwd_log['content'] | b64decode | regex_findall('.*temporary password.*') | join(' ') | split(' ') | last }}"

- name: Reset default root password of {{ COMPONENT }}
  ansible.builtin.mysql_user:
    name: root
    password: "{{ ROOT_PASSWORD }}"
    login_user: root
    login_password: "{{ DEFAULT_PASSWORD }}"
    host: localhost
    state: present
    update_password: always
    check_implicit_admin: yes

- name: Remove {{ COMPONENT }} password validate plugin
  ansible.builtin.mysql_db:
    name: "mysql"
    login_user: root
    login_password: "{{ ROOT_PASSWORD }}"
    state: import
    target: /etc/ansible/playbooks/uninstall_validate_password.sql

- name: Download {{ COMPONENT }} from GitHub
  ansible.builtin.get_url:
    url: "https://github.com/stans-robot-project/{{ COMPONENT }}/archive/main.zip"
    dest: /tmp/{{ COMPONENT }}.zip

- name: Extract {{ COMPONENT }}
  ansible.builtin.unarchive:
    src: /tmp/{{ COMPONENT }}.zip
    dest: /tmp/{{ COMPONENT }}
    remote_src: yes
